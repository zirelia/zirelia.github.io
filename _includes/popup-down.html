<!-- Popup CTA -->
<div id="cta-popup"
  class="hidden fixed bottom-6 right-6 max-w-sm w-full bg-white dark:bg-neutral-900 border border-gray-200 dark:border-white/10 rounded-2xl shadow-2xl z-50 transform translate-y-10 opacity-0 transition-all duration-500">

  <!-- Close Button -->
  <button id="cta-close-btn" aria-label="Close"
    class="absolute top-3 right-3 text-gray-400 hover:text-black dark:hover:text-white transition-colors p-2 min-w-[44px] min-h-[44px] flex items-center justify-center">
    <i class="fas fa-times"></i>
  </button>

  <div class="p-6">
    <div class="w-10 h-10 rounded-full bg-brand-purple/10 flex items-center justify-center mb-4 text-brand-purple text-lg">
      <i class="fas fa-robot"></i>
    </div>

    {% if page.lang == 'it' %}
    <h4 class="text-lg font-bold mb-2 text-neutral-900 dark:text-white">Lancia il tuo Virtual Influencer</h4>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Definisci una persona. Zirelia gestisce post, immagini e scheduling — 24/7, in automatico.
    </p>

    <a href="{{ site.cta.popup_url }}"
      class="block w-full py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold text-center hover:bg-brand-purple dark:hover:bg-brand-purple dark:hover:text-white transition-colors">
      <i class="fab fa-github mr-1"></i> Metti una stella su GitHub
    </a>
    {% else %}
    <h4 class="text-lg font-bold mb-2 text-neutral-900 dark:text-white">Launch Your Virtual Influencer</h4>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
      Define a persona. Zirelia handles posting, images, and scheduling — 24/7, automatically.
    </p>

    <a href="{{ site.cta.popup_url }}"
      class="block w-full py-3 rounded-xl bg-black dark:bg-white text-white dark:text-black font-bold text-center hover:bg-brand-purple dark:hover:bg-brand-purple dark:hover:text-white transition-colors">
      <i class="fab fa-github mr-1"></i> Star on GitHub
    </a>
    {% endif %}
  </div>
</div>

<script>
(function () {
  // Guard: prevent duplicate initialization if include is loaded multiple times
  if (window.__ctaPopupInit) return;
  window.__ctaPopupInit = true;

  document.addEventListener("DOMContentLoaded", function () {
    var cta = document.getElementById("cta-popup");
    var closeBtn = document.getElementById("cta-close-btn");
    if (!cta || !closeBtn) return;

    var isDismissed = localStorage.getItem('cta_popup_closed') === 'true';
    var shown = false;
    var pageReadyMs = Date.now();
    var MIN_TIME_MS = 8000;   // don't show before 8 seconds on page
    var SCROLL_THRESHOLD = 65; // show after 65% scroll depth

    function showPopup() {
      if (shown || isDismissed) return;
      shown = true;
      cta.classList.remove('hidden');
      requestAnimationFrame(function () {
        requestAnimationFrame(function () {
          cta.classList.remove('translate-y-10', 'opacity-0');
        });
      });
    }

    function hidePopup() {
      isDismissed = true;
      localStorage.setItem('cta_popup_closed', 'true');
      cta.classList.add('translate-y-10', 'opacity-0');
      setTimeout(function () {
        cta.classList.add('hidden');
      }, 500);
    }

    if (!isDismissed) {
      window.addEventListener("scroll", function onScroll() {
        if (isDismissed || shown) {
          window.removeEventListener("scroll", onScroll);
          return;
        }
        var docHeight = document.documentElement.scrollHeight;
        var scrollPos = window.scrollY + window.innerHeight;
        var scrollPercent = (scrollPos / docHeight) * 100;
        var elapsed = Date.now() - pageReadyMs;

        if (scrollPercent > SCROLL_THRESHOLD && elapsed > MIN_TIME_MS) {
          showPopup();
          window.removeEventListener("scroll", onScroll);
        }
      }, { passive: true });
    }

    // Close on button click
    closeBtn.addEventListener("click", hidePopup);

    // Close on Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && shown && !isDismissed) hidePopup();
    });

    // Mobile: swipe down to dismiss
    var touchStartY = 0;
    cta.addEventListener("touchstart", function (e) {
      touchStartY = e.touches[0].clientY;
    }, { passive: true });
    cta.addEventListener("touchend", function (e) {
      var dy = e.changedTouches[0].clientY - touchStartY;
      if (dy > 60) hidePopup(); // swipe down 60px = dismiss
    }, { passive: true });
  });
}());
</script>
